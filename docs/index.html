<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Visualização de dados abertos do Parlamento Português - Iniciativas legislativas e agenda parlamentar da XVII Legislatura">
    <title>Viriato - Dados Abertos do Parlamento Português</title>
    <style>
        /* CSS Custom Properties for consistent theming */
        /* Using Parlamento.pt teal color as base */
        :root {
            --primary: #00828A;
            --primary-dark: #006d74;
            --secondary: #005f66;
            --accent: #ed64a6;
            --success: #48bb78;
            --success-dark: #38a169;
            --info: #4299e1;
            --info-dark: #3182ce;
            --warning: #ed8936;
            --danger: #f56565;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --text-muted: #718096;
            --bg-primary: #f7fafc;
            --bg-card: #ffffff;
            --border-light: #e2e8f0;
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-glow: 0 0 20px rgba(0, 130, 138, 0.3);
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s ease;
            --transition-slow: 0.5s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Skip to content - Accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #667eea;
            color: white;
            padding: 8px 16px;
            z-index: 1001;
            transition: top 0.3s;
            text-decoration: none;
            font-weight: 600;
        }

        .skip-link:focus {
            top: 0;
        }

        /* Focus styles for accessibility */
        *:focus-visible {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        button:focus-visible,
        a:focus-visible {
            outline: 2px solid #667eea;
            outline-offset: 2px;
        }

        /* Navigation Tabs */
        .main-nav {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 0;
            box-shadow: var(--shadow-lg);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 0 24px;
        }

        .logo {
            color: white;
            font-size: 1.6rem;
            font-weight: 800;
            padding: 16px 0;
            margin-right: 48px;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-tabs {
            display: flex;
            gap: 4px;
            flex: 1;
        }

        .nav-tab {
            color: rgba(255,255,255,0.85);
            text-decoration: none;
            padding: 16px 28px;
            font-weight: 500;
            font-size: 0.95rem;
            letter-spacing: 0.3px;
            transition: all var(--transition-normal);
            border-bottom: 3px solid transparent;
            cursor: pointer;
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
        }

        .nav-tab:hover {
            color: white;
            background: rgba(255,255,255,0.12);
        }

        .nav-tab.active {
            color: white;
            border-bottom-color: white;
            background: rgba(255,255,255,0.18);
            font-weight: 600;
        }

        /* View Container */
        .view {
            display: none;
        }

        .view.active {
            display: block;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* HOME VIEW STYLES */
        .home-view {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: calc(100vh - 60px);
            padding: 80px 24px;
            position: relative;
        }

        .home-view::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
        }

        .home-header {
            text-align: center;
            color: white;
            margin-bottom: 64px;
            position: relative;
        }

        .home-header h1 {
            font-size: 3.5em;
            margin-bottom: 16px;
            font-weight: 800;
            letter-spacing: -1px;
            text-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .home-subtitle {
            font-size: 1.4em;
            opacity: 0.95;
            font-weight: 400;
            letter-spacing: 0.5px;
        }

        .home-description {
            max-width: 700px;
            margin: 24px auto 0;
            opacity: 0.9;
            font-size: 1.1em;
            line-height: 1.7;
        }

        .viewers {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 32px;
            max-width: 1000px;
            margin: 0 auto;
            position: relative;
        }

        .viewer-card {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 40px;
            cursor: pointer;
            transition: all var(--transition-normal);
            box-shadow: var(--shadow-xl);
            position: relative;
            overflow: hidden;
        }

        .viewer-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
            transition: height var(--transition-normal);
        }

        .viewer-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl), var(--shadow-glow);
        }

        .viewer-card:hover::before {
            height: 6px;
        }

        .viewer-icon {
            font-size: 3.5em;
            margin-bottom: 20px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .viewer-title {
            font-size: 1.75em;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        .viewer-description {
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .viewer-stats {
            display: flex;
            gap: 24px;
            margin-top: 28px;
            padding-top: 24px;
            border-top: 1px solid var(--border-light);
        }

        .stat {
            flex: 1;
            text-align: center;
        }

        .stat-value {
            font-size: 1.75em;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: block;
        }

        .stat-label {
            font-size: 0.8em;
            color: var(--text-muted);
            margin-top: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        /* INICIATIVAS VIEW STYLES */
        .iniciativas-header {
            text-align: center;
            margin-bottom: 32px;
            padding: 40px 24px;
            background: linear-gradient(135deg, #1a5f2a 0%, #2d8f4e 100%);
            color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .iniciativas-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M20 0L40 20L20 40L0 20z'/%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
        }

        .iniciativas-header h1 {
            font-size: 2.25rem;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -0.5px;
            position: relative;
        }

        .iniciativas-header p {
            opacity: 0.9;
            font-size: 1.05rem;
        }

        .stats {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 24px;
            flex-wrap: wrap;
            position: relative;
        }

        .stat-box {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            padding: 14px 28px;
            border-radius: var(--radius-md);
            border: 1px solid rgba(255,255,255,0.2);
            transition: all var(--transition-fast);
        }

        .stat-box:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 1.75rem;
            font-weight: 800;
        }

        .stat-box-label {
            font-size: 0.75rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filters {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 32px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
        }

        .filter-group {
            margin-bottom: 20px;
        }

        .filter-group:last-child {
            margin-bottom: 0;
        }

        .filter-label {
            font-weight: 600;
            margin-bottom: 12px;
            display: block;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 10px 20px;
            border: 2px solid var(--border-light);
            background: var(--bg-card);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .filter-btn:hover {
            border-color: var(--primary);
            background: #f0f4ff;
            color: var(--primary);
        }

        .filter-btn.active {
            border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Search */
        .search-container {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .search-input {
            flex: 1;
            padding: 14px 18px;
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-size: 1rem;
            transition: all var(--transition-fast);
            background: var(--bg-primary);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: var(--bg-card);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.35);
        }

        .search-btn:active {
            transform: translateY(0);
        }

        .search-btn:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .clear-search-btn {
            padding: 14px 20px;
            background: var(--bg-primary);
            color: var(--text-secondary);
            border: 2px solid var(--border-light);
            border-radius: var(--radius-md);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: none;
        }

        .clear-search-btn:hover {
            background: #fed7d7;
            border-color: #fc8181;
            color: #c53030;
        }

        .clear-search-btn.visible {
            display: block;
        }

        .search-results-info {
            margin-bottom: 16px;
            padding: 14px 18px;
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            border-radius: var(--radius-md);
            color: #3730a3;
            display: none;
            font-weight: 500;
            border: 1px solid #a5b4fc;
        }

        .search-results-info.visible {
            display: block;
        }

        /* Funnels */
        .funnels {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 28px;
            margin-bottom: 40px;
        }

        .funnel-container {
            background: var(--bg-card);
            padding: 28px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
        }

        .funnel-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 24px;
            text-align: center;
            color: var(--text-primary);
            letter-spacing: -0.3px;
        }

        .funnel-chart {
            display: flex;
            gap: 6px;
            justify-content: center;
            align-items: flex-end;
            min-height: 300px;
            padding: 0 8px;
        }

        .phase-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .phase-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            color: white;
            font-weight: 700;
            font-size: 0.85rem;
            min-width: 48px;
            transition: all var(--transition-fast);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .phase-bar:hover {
            transform: scale(1.08) translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
        }

        .phase-count {
            color: white;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .phase-name {
            font-size: 0.65rem;
            color: var(--text-muted);
            text-align: center;
            max-width: 65px;
            line-height: 1.3;
            font-weight: 500;
        }

        /* Analytics Widgets */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .widget {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-light);
        }

        .widget-title {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .widget-title-icon {
            font-size: 1.2rem;
        }

        /* Horizontal Bar Chart */
        .bar-chart {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .bar-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .bar-label {
            min-width: 80px;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            text-align: right;
        }

        .bar-track {
            flex: 1;
            height: 28px;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            min-width: 40px;
            transition: width 0.5s ease;
        }

        .bar-value {
            font-size: 0.8rem;
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .bar-value-outside {
            position: absolute;
            right: -35px;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
        }

        /* Party Colors */
        .party-PAN { background: linear-gradient(135deg, #2d8f4e, #1a5f2a); }
        .party-CH { background: linear-gradient(135deg, #1e3a5f, #0d1f33); }
        .party-PCP { background: linear-gradient(135deg, #dc2626, #b91c1c); }
        .party-L { background: linear-gradient(135deg, #16a34a, #15803d); }
        .party-PS { background: linear-gradient(135deg, #ec4899, #db2777); }
        .party-BE { background: linear-gradient(135deg, #7c3aed, #6d28d9); }
        .party-IL { background: linear-gradient(135deg, #06b6d4, #0891b2); }
        .party-CDS-PP { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .party-PSD { background: linear-gradient(135deg, #f97316, #ea580c); }
        .party-GOV { background: linear-gradient(135deg, #6b7280, #4b5563); }
        .party-default { background: linear-gradient(135deg, #94a3b8, #64748b); }

        /* Timeline Chart */
        .timeline-chart {
            display: flex;
            align-items: flex-end;
            gap: 4px;
            height: 120px;
            padding-top: 10px;
        }

        .timeline-bar {
            flex: 1;
            min-width: 20px;
            background: linear-gradient(180deg, var(--primary), var(--primary-dark));
            border-radius: var(--radius-sm) var(--radius-sm) 0 0;
            position: relative;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .timeline-bar:hover {
            filter: brightness(1.1);
            transform: scaleY(1.02);
            transform-origin: bottom;
        }

        .timeline-bar-label {
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.65rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .timeline-bar-value {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Type distribution mini cards */
        .type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .type-card {
            padding: 16px;
            border-radius: var(--radius-md);
            text-align: center;
            transition: all var(--transition-fast);
        }

        .type-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .type-card-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .type-card-label {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.9);
            margin-top: 4px;
            font-weight: 500;
        }

        /* Initiative cards */
        .initiative-card {
            background: var(--bg-card);
            padding: 24px;
            border-radius: var(--radius-lg);
            margin-bottom: 16px;
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: all var(--transition-normal);
            border: 1px solid var(--border-light);
            position: relative;
            text-align: left;
        }

        .initiative-card:hover {
            box-shadow: var(--shadow-lg);
            border-color: #cbd5e0;
            transform: translateY(-2px);
        }

        .initiative-card.expanded {
            box-shadow: var(--shadow-lg);
            border-color: var(--primary);
        }

        .initiative-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
        }

        .initiative-badge {
            padding: 6px 14px;
            border-radius: var(--radius-sm);
            font-weight: 700;
            font-size: 0.8rem;
            color: white;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }

        .type-P { background: linear-gradient(135deg, #2563eb, #1d4ed8); }
        .type-R { background: linear-gradient(135deg, #16a34a, #15803d); }
        .type-L { background: linear-gradient(135deg, #9333ea, #7c3aed); }
        .type-D { background: linear-gradient(135deg, #ea580c, #dc2626); }

        .initiative-number {
            color: var(--text-muted);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .initiative-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .initiative-meta {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 10px;
        }

        .initiative-status {
            color: var(--success-dark);
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .initiative-status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
        }

        /* Status category styles */
        .initiative-status.status-submitted {
            color: #6b7280;
        }
        .initiative-status.status-submitted::before {
            background: #9ca3af;
        }

        .initiative-status.status-announced {
            color: #0284c7;
        }
        .initiative-status.status-announced::before {
            background: #38bdf8;
        }

        .initiative-status.status-discussion {
            color: #2563eb;
        }
        .initiative-status.status-discussion::before {
            background: #3b82f6;
        }

        .initiative-status.status-voting {
            color: #ea580c;
        }
        .initiative-status.status-voting::before {
            background: #f97316;
        }

        .initiative-status.status-finalizing {
            color: #7c3aed;
        }
        .initiative-status.status-finalizing::before {
            background: #8b5cf6;
        }

        .initiative-status.status-approved {
            color: #059669;
        }
        .initiative-status.status-approved::before {
            background: #10b981;
        }

        .initiative-status.status-rejected {
            color: #dc2626;
        }
        .initiative-status.status-rejected::before {
            background: #ef4444;
        }

        .status-category-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.8;
        }

        .status-phase-name {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .initiative-details {
            max-height: 0;
            overflow: hidden;
            margin-top: 0;
            padding-top: 0;
            border-top: 1px solid transparent;
            font-size: 0.9rem;
            color: #4a5568;
            transition: max-height 0.3s ease, margin-top 0.3s ease, padding-top 0.3s ease, border-color 0.3s ease;
            text-align: left;
        }

        .initiative-card.expanded .initiative-details {
            max-height: 2000px;
            margin-top: 15px;
            padding-top: 15px;
            border-top-color: #e2e8f0;
        }

        .expand-indicator {
            text-align: center;
            color: #94a3b8;
            font-size: 0.85rem;
            margin-top: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .expand-icon {
            display: inline-block;
            transition: transform 0.3s ease;
        }

        .initiative-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        .timeline {
            margin-top: 15px;
        }

        .timeline-item {
            padding: 8px 0;
            border-left: 2px solid #e2e8f0;
            padding-left: 15px;
            margin-left: 5px;
        }

        .timeline-date {
            color: #94a3b8;
            font-size: 0.85rem;
            margin-right: 10px;
        }

        .timeline-phase {
            color: #475569;
        }

        /* AGENDA VIEW STYLES */
        .agenda-header {
            text-align: center;
            margin-bottom: 32px;
            padding: 40px 24px;
            background: linear-gradient(135deg, var(--info-dark) 0%, var(--info) 100%);
            color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .agenda-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Crect x='0' y='0' width='20' height='20'/%3E%3Crect x='20' y='20' width='20' height='20'/%3E%3C/g%3E%3C/svg%3E");
            pointer-events: none;
        }

        .agenda-header h1 {
            font-size: 2.25rem;
            margin-bottom: 8px;
            font-weight: 700;
            letter-spacing: -0.5px;
            position: relative;
        }

        .agenda-header p {
            opacity: 0.9;
            font-size: 1.05rem;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
            margin-bottom: 28px;
            padding: 20px;
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .legend-filter {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            padding: 6px 12px;
            border-radius: 20px;
            background: var(--bg-primary);
            border: 1px solid var(--border-light);
            transition: all 0.2s ease;
            user-select: none;
        }

        .legend-filter:hover {
            border-color: var(--primary);
        }

        .legend-filter.active {
            background: var(--bg-primary);
            border-color: var(--border-medium);
        }

        .legend-filter:not(.active) {
            opacity: 0.5;
            background: var(--bg-secondary);
        }

        .legend-filter input[type="checkbox"] {
            display: none;
        }

        .legend-shape {
            width: 16px;
            height: 16px;
            display: inline-block;
            border-radius: var(--radius-sm);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .bg-committee { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .bg-plenary { background: linear-gradient(135deg, #10b981, #059669); }
        .bg-groups { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .bg-conference { background: linear-gradient(135deg, #0891b2, #0e7490); }
        .bg-workgroup { background: linear-gradient(135deg, #ec4899, #db2777); }
        .bg-visits { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .bg-assistances { background: linear-gradient(135deg, #94a3b8, #64748b); }
        .bg-other { background: linear-gradient(135deg, #6b7280, #4b5563); }

        /* Calendar Grid - compact for 7 days */
        .calendar-grid {
            display: grid;
            grid-template-columns: 42px repeat(7, 1fr);
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            overflow: hidden;
            font-size: 0.65rem;
        }

        .calendar-day-header {
            background: #f8fafc;
            padding: 6px 2px;
            text-align: center;
            border-bottom: 1px solid var(--border-light);
            border-left: 1px solid #f1f5f9;
        }

        .calendar-day-header:first-child {
            border-left: none;
        }

        .calendar-day-header.today {
            background: #e6f4f5;
        }

        .calendar-day-name {
            font-size: 0.6rem;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
        }

        .calendar-day-date {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .calendar-day-header.today .calendar-day-date {
            background: #00828A;
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .time-label {
            background: #fafafa;
            padding: 1px 4px;
            text-align: right;
            color: var(--text-muted);
            font-size: 0.6rem;
            border-bottom: 1px solid #f1f5f9;
            height: 40px;
            display: flex;
            align-items: flex-start;
            justify-content: flex-end;
        }

        .grid-cell {
            border-bottom: 1px solid #f1f5f9;
            border-left: 1px solid #f1f5f9;
            min-height: 40px;
            padding: 1px;
            position: relative;
        }

        .grid-cell.today {
            background: #f0f9f9;
        }

        .agenda-event {
            padding: 2px 3px;
            border-radius: 2px;
            font-size: 0.58rem;
            margin-bottom: 1px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: default;
            line-height: 1.2;
        }

        .agenda-event:hover {
            white-space: normal;
            position: relative;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .agenda-event.plenary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-weight: 600;
        }

        .agenda-event.committee {
            background: #dbeafe;
            color: #1e40af;
        }

        .agenda-event.groups {
            background: #ede9fe;
            color: #5b21b6;
        }

        .agenda-event.conference {
            background: #cffafe;
            color: #0e7490;
        }

        .agenda-event.workgroup {
            background: #fce7f3;
            color: #9d174d;
        }

        .agenda-event.visits {
            background: #fef3c7;
            color: #92400e;
        }

        .agenda-event.assistances {
            background: #f1f5f9;
            color: #475569;
        }

        .agenda-event.other {
            background: #e5e7eb;
            color: #374151;
        }

        /* View Toggle */
        .agenda-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 12px;
        }

        .view-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg-primary);
            padding: 4px;
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
        }

        .view-btn {
            padding: 6px 14px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .view-btn:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .view-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Timeline View */
        .timeline-container {
            background: var(--bg-card);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-light);
            overflow-x: auto;
        }

        .timeline {
            display: grid;
            min-width: 1200px;
        }

        .hour-headers {
            display: grid;
            grid-template-columns: 100px repeat(15, 1fr);
            border-bottom: 1px solid var(--border-light);
            background: #f8fafc;
        }

        .hour-header {
            padding: 6px 4px;
            text-align: center;
            font-size: 0.65rem;
            font-weight: 600;
            color: var(--text-muted);
            border-left: 1px solid #f1f5f9;
        }

        .hour-header:first-child {
            border-left: none;
        }

        .day-row {
            display: grid;
            grid-template-columns: 100px 1fr;
            min-height: 28px;
            border-bottom: 2px solid #e2e8f0;
            position: relative;
        }

        .day-row:last-child {
            border-bottom: none;
        }

        .day-row.today {
            background: #f0f9f9;
        }

        .day-row.weekend {
            min-height: 20px;
            background: #f8fafc;
            opacity: 0.7;
        }

        .day-row.weekend .day-label {
            background: #f1f5f9;
            color: #94a3b8;
        }

        .day-row.weekend .events-area {
            background: #f8fafc;
        }

        .day-label {
            padding: 8px;
            background: #fafafa;
            border-right: 1px solid var(--border-light);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .timeline .day-name {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
        }

        .timeline .day-date {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .day-row.today .day-date {
            background: var(--primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .events-area {
            position: relative;
            min-height: 18px;
        }

        .hour-grid {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            pointer-events: none;
        }

        .hour-line {
            border-left: 1px solid #f1f5f9;
        }

        .hour-line:first-child {
            border-left: none;
        }

        .timeline-event {
            position: absolute;
            height: 16px;
            padding: 1px 4px;
            border-radius: 2px;
            font-size: 0.55rem;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: default;
            display: flex;
            align-items: center;
            text-align: left;
            z-index: 1;
            line-height: 1.1;
        }

        .timeline-event:hover {
            z-index: 100;
            box-shadow: 0 2px 8px rgba(0,0,0,0.25);
            white-space: normal;
            height: auto;
            min-height: 16px;
            max-width: 300px;
        }

        .timeline-event.plenary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-weight: 600;
        }

        .timeline-event.committee {
            background: #dbeafe;
            color: #1e40af;
            border-left: 2px solid #3b82f6;
        }

        .timeline-event.groups {
            background: #ede9fe;
            color: #5b21b6;
            border-left: 2px solid #8b5cf6;
        }

        .timeline-event.conference {
            background: #cffafe;
            color: #0e7490;
            border-left: 2px solid #0891b2;
        }

        .timeline-event.workgroup {
            background: #fce7f3;
            color: #9d174d;
            border-left: 2px solid #ec4899;
        }

        .timeline-event.visits {
            background: #fef3c7;
            color: #92400e;
            border-left: 2px solid #f59e0b;
        }

        .timeline-event.assistances {
            background: #f1f5f9;
            color: #475569;
            border-left: 2px solid #94a3b8;
        }

        .timeline-event.other {
            background: #e5e7eb;
            color: #374151;
            border-left: 2px solid #6b7280;
        }

        /* Event time - hidden on desktop, shown on mobile */
        .event-time {
            display: none;
        }

        .event-title {
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Loading & Error States */
        .loading {
            text-align: center;
            padding: 80px 24px;
            color: var(--text-muted);
            font-size: 1.1rem;
            font-weight: 500;
        }

        .loading::before {
            content: '';
            display: block;
            width: 48px;
            height: 48px;
            margin: 0 auto 24px;
            border: 4px solid var(--border-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            text-align: center;
            padding: 48px 24px;
            color: var(--danger);
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border-radius: var(--radius-lg);
            margin: 24px;
            border: 1px solid #fca5a5;
        }

        .error-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 12px;
        }

        .error-message {
            margin-bottom: 24px;
            color: #991b1b;
            line-height: 1.6;
        }

        .retry-btn {
            padding: 12px 28px;
            background: linear-gradient(135deg, var(--danger), #dc2626);
            color: white;
            border: none;
            border-radius: var(--radius-md);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3);
        }

        .retry-btn:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(245, 101, 101, 0.4);
        }

        .retry-btn:focus {
            outline: 2px solid var(--danger);
            outline-offset: 2px;
        }

        /* Footer */
        footer {
            text-align: center;
            padding: 48px 24px;
            color: var(--text-muted);
            background: linear-gradient(180deg, var(--bg-primary) 0%, #edf2f7 100%);
            border-top: 1px solid var(--border-light);
            margin-top: 64px;
        }

        footer p {
            font-size: 0.95rem;
            line-height: 1.8;
        }

        footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            transition: all var(--transition-fast);
        }

        footer a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        /* Responsive */
        @media (max-width: 900px) {
            .nav-container {
                flex-direction: column;
                align-items: flex-start;
            }

            .logo {
                margin-right: 0;
                margin-bottom: 10px;
            }

            .nav-tabs {
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
            }

            .nav-tabs::-webkit-scrollbar {
                display: none;
            }

            .viewers {
                grid-template-columns: 1fr;
            }

            .funnels {
                grid-template-columns: 1fr;
            }

            .home-header h1 {
                font-size: 2em;
            }

            .search-container {
                flex-direction: column;
            }

            .search-btn,
            .clear-search-btn {
                width: 100%;
            }
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }

            .home-view {
                padding: 30px 15px;
            }

            .home-header h1 {
                font-size: 1.8em;
            }

            .home-subtitle {
                font-size: 1.1em;
            }

            .viewer-card {
                padding: 25px;
            }

            .viewer-stats {
                flex-direction: column;
                gap: 15px;
            }

            .filter-buttons {
                flex-direction: column;
            }

            .filter-btn {
                width: 100%;
                text-align: center;
            }

            .funnel-chart {
                overflow-x: auto;
                justify-content: flex-start;
                padding-bottom: 10px;
            }

            .phase-step {
                min-width: 45px;
            }

            .initiative-meta {
                flex-direction: column;
                gap: 5px;
            }

            .stats {
                flex-direction: column;
                gap: 10px;
            }

            .stat-box {
                width: 100%;
            }
        }

        /* Mobile-friendly Agenda Styles */
        @media (max-width: 900px) {
            /* Legend filters - horizontal scroll on tablet */
            .agenda-controls .legend {
                justify-content: flex-start;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                padding: 16px;
                gap: 10px;
            }

            .agenda-controls .legend::-webkit-scrollbar {
                display: none;
            }

            .legend-filter {
                flex-shrink: 0;
                padding: 8px 14px;
            }

            /* Timeline adjustments for tablet */
            .timeline {
                min-width: 900px;
            }

            .hour-headers {
                grid-template-columns: 80px repeat(15, 1fr);
            }

            .day-row {
                grid-template-columns: 80px 1fr;
            }

            .day-label {
                padding: 6px;
            }
        }

        @media (max-width: 768px) {
            /* Agenda header */
            .agenda-header h1 {
                font-size: 1.5rem;
            }

            .agenda-header p {
                font-size: 0.95rem;
            }

            /* Legend - more compact */
            .agenda-controls .legend {
                padding: 12px;
                gap: 8px;
                margin-bottom: 16px;
            }

            .legend-filter {
                padding: 6px 10px;
                font-size: 0.8rem;
                white-space: nowrap;
            }

            .legend-shape {
                width: 18px;
                height: 18px;
            }

            /* View toggle */
            .view-toggle {
                width: 100%;
                justify-content: center;
                margin-bottom: 16px;
            }

            .view-btn {
                flex: 1;
                text-align: center;
            }

            /* Timeline - switch to mobile card layout */
            .timeline-container {
                overflow-x: hidden;
            }

            .timeline {
                min-width: unset;
                display: block;
            }

            .hour-headers {
                display: none;
            }

            .day-row {
                display: block;
                min-height: unset;
                border-bottom: 1px solid var(--border-light);
                padding: 12px;
            }

            .day-row.weekend {
                min-height: unset;
                padding: 8px 12px;
            }

            .day-label {
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 8px;
                padding: 0;
                margin-bottom: 10px;
                border-right: none;
                background: transparent;
            }

            .timeline .day-name {
                font-size: 0.75rem;
            }

            .timeline .day-date {
                font-size: 1rem;
            }

            .events-area {
                position: static;
                display: flex;
                flex-direction: column;
                gap: 8px;
                height: auto !important;
            }

            .hour-grid {
                display: none;
            }

            .timeline-event {
                position: static !important;
                left: unset !important;
                width: 100% !important;
                top: unset !important;
                height: auto;
                min-height: 44px;
                padding: 10px 12px;
                border-radius: var(--radius-sm);
                font-size: 0.85rem;
                white-space: normal;
                line-height: 1.4;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .timeline-event:hover {
                max-width: none;
            }

            /* Show event time on mobile */
            .event-time {
                display: inline-block;
                font-weight: 600;
                font-size: 0.8rem;
                min-width: 45px;
                flex-shrink: 0;
                opacity: 0.9;
            }

            .event-title {
                flex: 1;
            }

            /* Calendar Grid - mobile optimizations with horizontal scroll */
            .calendar-grid {
                font-size: 0.75rem;
                min-width: 600px;
                overflow-x: auto;
            }

            .calendar-day-header {
                padding: 8px 4px;
            }

            .calendar-day-name {
                font-size: 0.55rem;
            }

            .calendar-day-date {
                font-size: 0.8rem;
            }

            .time-label {
                font-size: 0.55rem;
                padding: 2px;
            }

            .grid-cell {
                min-height: 35px;
            }

            .agenda-event {
                padding: 4px 6px;
                font-size: 0.65rem;
                min-height: 32px;
                display: flex;
                align-items: center;
            }

            .agenda-event:hover {
                min-height: 32px;
            }
        }

        @media (max-width: 480px) {
            /* Extra small phones */
            .agenda-header h1 {
                font-size: 1.3rem;
            }

            .agenda-header p {
                font-size: 0.85rem;
            }

            .agenda-controls .legend {
                padding: 10px;
                gap: 6px;
            }

            .legend-filter {
                padding: 8px 12px;
                font-size: 0.75rem;
            }

            .legend-shape {
                width: 18px;
                height: 18px;
            }

            .view-btn {
                padding: 8px 12px;
                font-size: 0.75rem;
            }

            .day-row {
                padding: 10px;
            }

            .timeline-event {
                padding: 8px 10px;
                font-size: 0.8rem;
                min-height: 40px;
            }

            /* Modal adjustments */
            .modal-content {
                width: 95%;
                max-height: 90vh;
                margin: 10px;
            }

            .modal-header {
                padding: 16px;
            }

            .modal-header h2 {
                font-size: 1rem;
            }

            .modal-body {
                padding: 16px;
            }

            .modal-close {
                width: 36px;
                height: 36px;
                font-size: 1.2rem;
            }
        }

        /* Reduced motion preference */
        @media (prefers-reduced-motion: reduce) {
            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* AGENDA INITIATIVES MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            animation: fadeIn 0.2s ease-out;
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            max-width: 900px;
            max-height: 85vh;
            width: 90%;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 24px 28px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            background: linear-gradient(to bottom, #f8fafc, #ffffff);
        }

        .modal-header-content {
            flex: 1;
            margin-right: 20px;
        }

        .modal-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .modal-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-sm);
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px 28px;
            overflow-y: auto;
            max-height: calc(85vh - 140px);
        }

        .modal-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-tertiary);
        }

        .modal-empty-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            opacity: 0.5;
        }

        .event-description {
            background: var(--bg-secondary);
            border-left: 3px solid var(--primary);
            padding: 16px 20px;
            margin-bottom: 20px;
            border-radius: 0 var(--radius-md) var(--radius-md) 0;
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .event-description p {
            margin: 0 0 8px 0;
        }

        .event-description p:last-child {
            margin-bottom: 0;
        }

        .initiatives-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-light);
        }

        .linked-initiative {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            padding: 16px;
            margin-bottom: 12px;
            transition: all 0.2s;
        }

        .linked-initiative:hover {
            border-color: var(--primary);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.1);
        }

        .initiative-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 10px;
        }

        .initiative-type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 600;
            background: var(--primary-light);
            color: var(--primary);
        }

        .initiative-id {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            font-weight: 500;
        }

        .initiative-title-text {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .initiative-meta-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .initiative-meta-item {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .initiative-meta-label {
            font-weight: 600;
            color: var(--text-tertiary);
        }

        .linked-initiative .initiative-status {
            padding: 3px 8px;
            border-radius: var(--radius-sm);
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-block;
        }

        .linked-initiative .initiative-status::before {
            display: none;
        }

        .linked-initiative .initiative-status.status-submitted {
            background: #f3f4f6;
            color: #6b7280;
        }

        .linked-initiative .initiative-status.status-announced {
            background: #e0f2fe;
            color: #0284c7;
        }

        .linked-initiative .initiative-status.status-discussion {
            background: #dbeafe;
            color: #2563eb;
        }

        .linked-initiative .initiative-status.status-voting {
            background: #ffedd5;
            color: #ea580c;
        }

        .linked-initiative .initiative-status.status-finalizing {
            background: #ede9fe;
            color: #7c3aed;
        }

        .linked-initiative .initiative-status.status-approved {
            background: #d1fae5;
            color: #059669;
        }

        .linked-initiative .initiative-status.status-rejected {
            background: #fee2e2;
            color: #dc2626;
        }

        .initiative-link-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--primary);
            text-decoration: none;
            font-weight: 500;
            margin-top: 8px;
            transition: opacity 0.2s;
        }

        .initiative-link-btn:hover {
            opacity: 0.7;
        }

        .modal-loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .modal-loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .modal-error {
            text-align: center;
            padding: 40px 20px;
            color: #dc2626;
        }

        .modal-error-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        /* Make agenda events clickable */
        .agenda-event {
            cursor: pointer;
            user-select: none;
        }

        .timeline-event {
            cursor: pointer;
            user-select: none;
        }
    </style>
</head>
<body>
    <!-- Skip to content - Accessibility -->
    <a href="#main-content" class="skip-link">Saltar para o conteúdo</a>

    <!-- Navigation -->
    <nav class="main-nav" role="navigation" aria-label="Navegação principal">
        <div class="nav-container">
            <div class="logo" aria-label="Viriato - Página inicial">Viriato</div>
            <div class="nav-tabs" role="tablist" aria-label="Secções do site">
                <a href="#/" class="nav-tab" data-view="home" role="tab" aria-selected="true">Home</a>
                <a href="#/iniciativas" class="nav-tab" data-view="iniciativas" role="tab" aria-selected="false">Iniciativas</a>
                <a href="#/agenda" class="nav-tab" data-view="agenda" role="tab" aria-selected="false">Agenda</a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main id="main-content">

    <!-- HOME VIEW -->
    <div id="home-view" class="view active home-view" role="tabpanel" aria-labelledby="home-tab">
        <div class="container">
            <div class="home-header">
                <h1>Viriato</h1>
                <div class="home-subtitle">Dados Abertos do Parlamento Português</div>
                <div class="home-description">
                    Visualização da atividade legislativa da XVII Legislatura (2025-presente).
                    Explore a agenda parlamentar e as iniciativas legislativas.
                </div>
            </div>

            <div class="viewers">
                <div class="viewer-card" onclick="navigateTo('#/agenda')" onkeydown="handleCardKeydown(event, '#/agenda')" tabindex="0" role="button" aria-label="Ver Agenda Parlamentar">
                    <div class="viewer-icon" aria-hidden="true">📅</div>
                    <div class="viewer-title">Agenda Parlamentar</div>
                    <div class="viewer-description">
                        Consulte o calendário parlamentar com sessões plenárias, reuniões de comissões e outros eventos.
                    </div>
                    <div class="viewer-stats">
                        <div class="stat">
                            <span class="stat-value" id="home-agenda-count">34</span>
                            <div class="stat-label">Eventos</div>
                        </div>
                        <div class="stat">
                            <span class="stat-value">Jan 2026</span>
                            <div class="stat-label">Atual</div>
                        </div>
                    </div>
                </div>

                <div class="viewer-card" onclick="navigateTo('#/iniciativas')" onkeydown="handleCardKeydown(event, '#/iniciativas')" tabindex="0" role="button" aria-label="Ver Iniciativas Legislativas">
                    <div class="viewer-icon" aria-hidden="true">📋</div>
                    <div class="viewer-title">Iniciativas Legislativas</div>
                    <div class="viewer-description">
                        Explore as iniciativas legislativas ao longo de todas as fases do processo parlamentar.
                    </div>
                    <div class="viewer-stats">
                        <div class="stat">
                            <span class="stat-value" id="home-ini-count">808</span>
                            <div class="stat-label">Iniciativas</div>
                        </div>
                        <div class="stat">
                            <span class="stat-value" id="home-ini-completed">102</span>
                            <div class="stat-label">Concluídas</div>
                        </div>
                        <div class="stat">
                            <span class="stat-value">7</span>
                            <div class="stat-label">Tipos</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- INICIATIVAS VIEW -->
    <div id="iniciativas-view" class="view" role="tabpanel" aria-labelledby="iniciativas-tab">
        <div class="container">
            <div class="iniciativas-header">
                <h1>Iniciativas Legislativas</h1>
                <p>XVII Legislature (2025-present)</p>
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-number" id="ini-total">-</div>
                        <div class="stat-box-label">Total Iniciativas</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="ini-completed">-</div>
                        <div class="stat-box-label">Completed</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="ini-phases">60</div>
                        <div class="stat-box-label">Lifecycle Phases</div>
                    </div>
                </div>
            </div>

            <div class="filters">
                <div class="filter-group">
                    <label class="filter-label" id="legislature-label">Legislatura:</label>
                    <div class="filter-buttons" role="group" aria-labelledby="legislature-label">
                        <button class="filter-btn" data-legislature="all">Todas</button>
                        <button class="filter-btn active" data-legislature="XVII">XVII (2025-presente)</button>
                        <button class="filter-btn" data-legislature="XVI">XVI (2024-2025)</button>
                        <button class="filter-btn" data-legislature="XV">XV (2022-2024)</button>
                        <button class="filter-btn" data-legislature="XIV">XIV (2019-2022)</button>
                    </div>
                </div>
                <div class="filter-group">
                    <label class="filter-label" id="search-label">Pesquisar Iniciativas:</label>
                    <div class="search-container" role="search">
                        <input type="text" id="search-input" class="search-input" placeholder="Pesquisar por título (ex: 'saúde', 'educação', 'ambiente')..." aria-label="Pesquisar iniciativas" />
                        <button id="search-btn" class="search-btn" onclick="performSearch()" aria-label="Pesquisar">Pesquisar</button>
                        <button id="clear-search-btn" class="clear-search-btn" onclick="clearSearch()" aria-label="Limpar pesquisa">Limpar</button>
                    </div>
                    <div id="search-results-info" class="search-results-info"></div>
                </div>
                <div class="filter-group">
                    <label class="filter-label" id="filter-label">Filtrar por Tipo:</label>
                    <div class="filter-buttons" role="group" aria-labelledby="filter-label">
                        <button class="filter-btn active" data-type="all">Todos</button>
                        <button class="filter-btn" data-type="P">Projetos de Lei</button>
                        <button class="filter-btn" data-type="R">Projetos de Resolução</button>
                        <button class="filter-btn" data-type="L">Propostas de Lei</button>
                        <button class="filter-btn" data-type="D">Deliberações</button>
                    </div>
                </div>
            </div>

            <div class="funnels">
                <div class="funnel-container">
                    <div class="funnel-title">Leis - Estado Atual</div>
                    <div id="laws-funnel" class="funnel-chart"></div>
                </div>
                <div class="funnel-container">
                    <div class="funnel-title">Resoluções - Estado Atual</div>
                    <div id="resolutions-funnel" class="funnel-chart"></div>
                </div>
            </div>

            <!-- Analytics Widgets -->
            <div class="analytics-grid" id="analytics-widgets">
                <div class="widget">
                    <div class="widget-title">
                        <span class="widget-title-icon" aria-hidden="true">📊</span>
                        Por Tipo
                    </div>
                    <div id="type-widget" class="type-grid">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="widget">
                    <div class="widget-title">
                        <span class="widget-title-icon" aria-hidden="true">📅</span>
                        Por Mês
                    </div>
                    <div id="month-widget" class="timeline-chart" style="margin-bottom: 30px;">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div class="widget">
                    <div class="widget-title">
                        <span class="widget-title-icon" aria-hidden="true">👤</span>
                        Por Autor
                    </div>
                    <div id="author-widget" class="bar-chart">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>

            <div id="initiatives" class="loading" role="status" aria-live="polite">A carregar iniciativas...</div>
        </div>
    </div>

    <!-- AGENDA VIEW -->
    <div id="agenda-view" class="view" role="tabpanel" aria-labelledby="agenda-tab">
        <div class="container">
            <div class="agenda-header">
                <h1>Agenda Parlamentar</h1>
                <p>Calendário da XVII Legislatura</p>
            </div>

            <div class="agenda-controls">
                <div class="legend">
                    <label class="legend-filter active" data-type="plenary">
                        <input type="checkbox" checked onchange="toggleAgendaFilter('plenary', this.checked)">
                        <span class="legend-shape bg-plenary"></span>
                        <span>Plenário</span>
                    </label>
                    <label class="legend-filter active" data-type="committee">
                        <input type="checkbox" checked onchange="toggleAgendaFilter('committee', this.checked)">
                        <span class="legend-shape bg-committee"></span>
                        <span>Comissões</span>
                    </label>
                    <label class="legend-filter active" data-type="groups">
                        <input type="checkbox" checked onchange="toggleAgendaFilter('groups', this.checked)">
                        <span class="legend-shape bg-groups"></span>
                        <span>Grupos Parlamentares</span>
                    </label>
                    <label class="legend-filter active" data-type="conference">
                        <input type="checkbox" checked onchange="toggleAgendaFilter('conference', this.checked)">
                        <span class="legend-shape bg-conference"></span>
                        <span>Conf. Líderes</span>
                    </label>
                    <label class="legend-filter active" data-type="workgroup">
                        <input type="checkbox" checked onchange="toggleAgendaFilter('workgroup', this.checked)">
                        <span class="legend-shape bg-workgroup"></span>
                        <span>Grupos Trabalho</span>
                    </label>
                    <label class="legend-filter active" data-type="visits">
                        <input type="checkbox" checked onchange="toggleAgendaFilter('visits', this.checked)">
                        <span class="legend-shape bg-visits"></span>
                        <span>Visitas</span>
                    </label>
                    <label class="legend-filter active" data-type="assistances">
                        <input type="checkbox" checked onchange="toggleAgendaFilter('assistances', this.checked)">
                        <span class="legend-shape bg-assistances"></span>
                        <span>Assistências</span>
                    </label>
                </div>
                <div class="view-toggle">
                    <button class="view-btn" data-view="grid" onclick="setAgendaView('grid')">Grelha</button>
                    <button class="view-btn active" data-view="timeline" onclick="setAgendaView('timeline')">Cronograma</button>
                </div>
            </div>

            <div id="agenda" class="loading" role="status" aria-live="polite">A carregar agenda...</div>
        </div>
    </div>

    </main>

    <!-- Footer -->
    <footer>
        <p>
            Fonte de dados: <a href="https://www.parlamento.pt" target="_blank">Parlamento.pt</a> |
            XVII Legislatura (2025-presente) |
            API: <a href="https://viriato-api.onrender.com/api/health" target="_blank">viriato-api.onrender.com</a>
        </p>
    </footer>

    <script>
        // API Configuration
        const API_URL = 'https://viriato-api.onrender.com';

        // Global data
        let INITIATIVES_DATA = [];
        let AGENDA_DATA = [];
        let SEARCH_RESULTS = null;  // null = no search, array = search results
        let SELECTED_LEGISLATURE = 'XVII';  // Track selected legislature (default to current)

        // Page titles for each route
        const PAGE_TITLES = {
            'home': 'Viriato - Dados Abertos do Parlamento Português',
            'iniciativas': 'Iniciativas Legislativas - Viriato',
            'agenda': 'Agenda Parlamentar - Viriato'
        };

        // Router
        function navigateTo(hash) {
            window.location.hash = hash;
        }

        // Keyboard handler for cards
        function handleCardKeydown(event, hash) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                navigateTo(hash);
            }
        }

        function handleRoute() {
            const hash = window.location.hash || '#/';
            const route = hash.substring(2) || 'home';

            // Update page title
            document.title = PAGE_TITLES[route] || PAGE_TITLES['home'];

            // Update active tab and aria-selected
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });
            const activeTab = document.querySelector(`[data-view="${route}"]`);
            if (activeTab) {
                activeTab.classList.add('active');
                activeTab.setAttribute('aria-selected', 'true');
            }

            // Update active view
            document.querySelectorAll('.view').forEach(view => {
                view.classList.remove('active');
            });
            const activeView = document.getElementById(`${route}-view`);
            if (activeView) {
                activeView.classList.add('active');

                // Load data for view if needed
                if (route === 'iniciativas' && INITIATIVES_DATA.length === 0) {
                    loadInitiatives();
                } else if (route === 'agenda' && AGENDA_DATA.length === 0) {
                    loadAgenda();
                }
            }
        }

        // Load Initiatives Data
        async function loadInitiatives() {
            try {
                // Build URL with legislature filter if selected
                let url = `${API_URL}/api/iniciativas`;
                if (SELECTED_LEGISLATURE !== 'all') {
                    url += `?legislature=${SELECTED_LEGISLATURE}`;
                }

                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                INITIATIVES_DATA = await response.json();
                console.log(`Loaded ${INITIATIVES_DATA.length} initiatives for legislature ${SELECTED_LEGISLATURE}`);

                // Update stats
                document.getElementById('ini-total').textContent = INITIATIVES_DATA.length;
                const completed = INITIATIVES_DATA.filter(i => i._isCompleted).length;
                document.getElementById('ini-completed').textContent = completed;
                document.getElementById('home-ini-count').textContent = INITIATIVES_DATA.length;
                document.getElementById('home-ini-completed').textContent = completed;

                // Update header to show selected legislature
                const headerText = document.querySelector('.iniciativas-header p');
                if (SELECTED_LEGISLATURE === 'all') {
                    headerText.textContent = 'All Legislatures (XIV-XVII)';
                } else if (SELECTED_LEGISLATURE === 'XVII') {
                    headerText.textContent = 'XVII Legislature (2025-present)';
                } else {
                    headerText.textContent = `Legislature ${SELECTED_LEGISLATURE}`;
                }

                renderLifecycleFunnels();
                renderAnalyticsWidgets();
                renderInitiatives('all');
                setupFilters();
            } catch (error) {
                console.error('Error loading initiatives:', error);
                document.getElementById('initiatives').innerHTML = `
                    <div class="error" role="alert">
                        <div class="error-title">Erro ao carregar iniciativas</div>
                        <div class="error-message">O servidor pode estar a iniciar (aguarde 10-30 segundos) ou houve um problema de ligação.</div>
                        <button class="retry-btn" onclick="retryLoadInitiatives()">Tentar novamente</button>
                    </div>`;
            }
        }

        function retryLoadInitiatives() {
            document.getElementById('initiatives').innerHTML = '<div class="loading">A carregar iniciativas...</div>';
            INITIATIVES_DATA = [];
            loadInitiatives();
        }

        // Load Agenda Data
        async function loadAgenda() {
            try {
                const response = await fetch(`${API_URL}/api/agenda`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                AGENDA_DATA = await response.json();
                console.log(`Loaded ${AGENDA_DATA.length} agenda events`);

                document.getElementById('home-agenda-count').textContent = AGENDA_DATA.length;

                // Render based on current view
                if (CURRENT_AGENDA_VIEW === 'timeline') {
                    renderAgendaTimeline();
                } else {
                    renderAgenda();
                }
            } catch (error) {
                console.error('Error loading agenda:', error);
                document.getElementById('agenda').innerHTML = `
                    <div class="error" role="alert">
                        <div class="error-title">Erro ao carregar agenda</div>
                        <div class="error-message">O servidor pode estar a iniciar (aguarde 10-30 segundos) ou houve um problema de ligação.</div>
                        <button class="retry-btn" onclick="retryLoadAgenda()">Tentar novamente</button>
                    </div>`;
            }
        }

        function retryLoadAgenda() {
            document.getElementById('agenda').innerHTML = '<div class="loading">A carregar agenda...</div>';
            AGENDA_DATA = [];
            loadAgenda();
        }

        // Render Lifecycle Funnels
        function renderLifecycleFunnels() {
            // Define phase orders for each lifecycle path
            const lawsPhaseOrder = [
                'Entrada',
                'Admissão',
                'Anúncio',
                'Discussão na generalidade',
                'Votação na generalidade',
                'Baixa comissão especialidade',
                'Votação final global',
                'Enviado para promulgação',
                'Promulgação',
                'Referenda ministerial',
                'Publicação'
            ];

            const resolutionsPhaseOrder = [
                'Entrada',
                'Admissão',
                'Anúncio',
                'Discussão',
                'Votação na generalidade',
                'Votação deliberação',
                'Redação final',
                'Publicação (DAR)',
                'Publicação (DR)'
            ];

            // Phase name mappings (full name -> display name)
            const phaseDisplayNames = {
                'Entrada': 'Entrada',
                'Admissão': 'Admissão',
                'Anúncio': 'Anúncio',
                'Discussão na generalidade': 'Discussão',
                'Discussão': 'Discussão',
                'Votação na generalidade': 'Votação generalidade',
                'Baixa comissão especialidade': 'Comissão especialidade',
                'Votação final global': 'Votação final',
                'Enviado para promulgação': 'Envio promulgação',
                'Promulgação': 'Promulgação',
                'Referenda ministerial': 'Referenda',
                'Publicação': 'Lei (DR)',
                'Votação deliberação': 'Votação deliberação',
                'Redação final': 'Redação final',
                'Publicação (DAR)': 'Resolução (DAR)',
                'Publicação (DR)': 'Resolução (DR)'
            };

            // Count initiatives that reached each phase
            function countPhasesForType(initiatives, phaseOrder) {
                const counts = {};
                phaseOrder.forEach(phase => counts[phase] = 0);

                initiatives.forEach(ini => {
                    const events = ini.IniEventos || [];
                    const phases = new Set(events.map(e => e.Fase));

                    phaseOrder.forEach(phase => {
                        // Check if this initiative has reached this phase
                        // Match by phase name contains (for flexibility)
                        const hasPhase = events.some(e => {
                            const eventPhase = e.Fase || '';
                            return eventPhase.includes(phase) || phase.includes(eventPhase.split(' - ')[0]);
                        });
                        if (hasPhase) counts[phase]++;
                    });
                });

                return phaseOrder.map(phase => ({
                    name: phaseDisplayNames[phase] || phase,
                    count: counts[phase]
                }));
            }

            // Filter initiatives by type for funnel calculation
            // Laws: J (Projeto de Lei) and P (Proposta de Lei)
            // Resolutions: R (Projeto de Resolução) and S (Proposta de Resolução)
            const lawsInitiatives = INITIATIVES_DATA.filter(ini =>
                ini.IniTipo === 'J' || ini.IniTipo === 'P'
            );
            const resolutionsInitiatives = INITIATIVES_DATA.filter(ini =>
                ini.IniTipo === 'R' || ini.IniTipo === 'S'
            );

            // Use simplified status categories for funnels
            let lawsPhases, resolutionsPhases;

            if (INITIATIVES_DATA.length > 0) {
                // Compute from data using simplified status categories
                lawsPhases = computeSimplifiedFunnel(lawsInitiatives);
                resolutionsPhases = computeSimplifiedFunnel(resolutionsInitiatives);
            } else {
                // Fallback to hardcoded values (simplified categories)
                lawsPhases = [
                    { name: 'Submetida', count: 50, color: '#9ca3af' },
                    { name: 'Anunciada', count: 180, color: '#38bdf8' },
                    { name: 'Em discussão', count: 45, color: '#3b82f6' },
                    { name: 'Em votação', count: 30, color: '#f97316' },
                    { name: 'A finalizar', count: 10, color: '#8b5cf6' },
                    { name: 'Aprovada', count: 14, color: '#10b981' },
                    { name: 'Rejeitada', count: 5, color: '#ef4444' }
                ];

                resolutionsPhases = [
                    { name: 'Submetida', count: 80, color: '#9ca3af' },
                    { name: 'Anunciada', count: 250, color: '#38bdf8' },
                    { name: 'Em discussão', count: 60, color: '#3b82f6' },
                    { name: 'Em votação', count: 40, color: '#f97316' },
                    { name: 'A finalizar', count: 15, color: '#8b5cf6' },
                    { name: 'Aprovada', count: 81, color: '#10b981' },
                    { name: 'Rejeitada', count: 8, color: '#ef4444' }
                ];
            }

            renderFunnelChart('laws-funnel', lawsPhases, '#3b82f6');
            renderFunnelChart('resolutions-funnel', resolutionsPhases, '#10b981');
        }

        function computeFunnelFromData(initiatives, type) {
            // Define phase patterns for matching
            const lawsPatterns = [
                { name: 'Entrada', pattern: /entrada/i },
                { name: 'Admissão', pattern: /admiss[ãa]o/i },
                { name: 'Anúncio', pattern: /an[úu]ncio/i },
                { name: 'Discussão', pattern: /discuss[ãa]o.*generalidade|generalidade.*discuss/i },
                { name: 'Votação generalidade', pattern: /vota[çc][ãa]o.*generalidade/i },
                { name: 'Comissão especialidade', pattern: /especialidade|comiss[ãa]o/i },
                { name: 'Votação final', pattern: /vota[çc][ãa]o.*final|final.*global/i },
                { name: 'Envio promulgação', pattern: /enviado.*promulga[çc][ãa]o|promulga[çc][ãa]o.*enviad/i },
                { name: 'Promulgação', pattern: /^promulga[çc][ãa]o$|decreto.*promulga/i },
                { name: 'Referenda', pattern: /referenda/i },
                { name: 'Lei (DR)', pattern: /publica[çc][ãa]o.*dr|di[áa]rio.*rep[úu]blica|lei.*publicad/i }
            ];

            const resolutionsPatterns = [
                { name: 'Entrada', pattern: /entrada/i },
                { name: 'Admissão', pattern: /admiss[ãa]o/i },
                { name: 'Anúncio', pattern: /an[úu]ncio/i },
                { name: 'Discussão', pattern: /discuss[ãa]o/i },
                { name: 'Votação generalidade', pattern: /vota[çc][ãa]o.*generalidade/i },
                { name: 'Votação deliberação', pattern: /delibera[çc][ãa]o|vota[çc][ãa]o.*deliber/i },
                { name: 'Redação final', pattern: /reda[çc][ãa]o.*final/i },
                { name: 'Resolução (DAR)', pattern: /dar|di[áa]rio.*assembleia/i },
                { name: 'Resolução (DR)', pattern: /dr|di[áa]rio.*rep[úu]blica/i }
            ];

            const patterns = type === 'laws' ? lawsPatterns : resolutionsPatterns;
            const counts = patterns.map(p => ({ name: p.name, count: 0 }));

            initiatives.forEach(ini => {
                const events = ini.IniEventos || [];
                const allPhases = events.map(e => (e.Fase || '').toLowerCase()).join(' ');

                patterns.forEach((p, i) => {
                    if (p.pattern.test(allPhases)) {
                        counts[i].count++;
                    }
                });
            });

            return counts;
        }

        // Compute simplified funnel using status categories
        function computeSimplifiedFunnel(initiatives) {
            // Define the category order and colors
            const categoryConfig = [
                { category: 'submitted', label: 'Submetida', color: '#9ca3af' },
                { category: 'announced', label: 'Anunciada', color: '#38bdf8' },
                { category: 'discussion', label: 'Em discussão', color: '#3b82f6' },
                { category: 'voting', label: 'Em votação', color: '#f97316' },
                { category: 'finalizing', label: 'A finalizar', color: '#8b5cf6' },
                { category: 'approved', label: 'Aprovada', color: '#10b981' },
                { category: 'rejected', label: 'Rejeitada', color: '#ef4444' }
            ];

            // Count initiatives by category
            const counts = {};
            categoryConfig.forEach(c => counts[c.category] = 0);

            initiatives.forEach(ini => {
                const status = ini._currentStatus || 'Desconhecido';
                const { category } = getStatusCategory(status);
                counts[category]++;
            });

            // Return array with counts and colors
            return categoryConfig.map(c => ({
                name: c.label,
                count: counts[c.category],
                color: c.color
            }));
        }

        function renderFunnelChart(containerId, phases, defaultColor) {
            const container = document.getElementById(containerId);
            const maxCount = Math.max(...phases.map(p => p.count));

            let html = '';
            phases.forEach(phase => {
                const heightPercent = (phase.count / maxCount) * 100;
                const height = Math.max(heightPercent * 2, 40);
                const barColor = phase.color || defaultColor;

                html += `
                    <div class="phase-step">
                        <div class="phase-bar" style="height: ${height}px; background: ${barColor};">
                            <div class="phase-count">${phase.count}</div>
                        </div>
                        <div class="phase-name">${phase.name}</div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Render Analytics Widgets
        function renderAnalyticsWidgets() {
            renderTypeWidget();
            renderMonthWidget();
            renderAuthorWidget();
        }

        function renderTypeWidget() {
            const container = document.getElementById('type-widget');

            // Count by type
            const typeCounts = {};
            INITIATIVES_DATA.forEach(ini => {
                const type = ini.IniTipo || 'Outro';
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });

            // Type display names and colors (all 7 initiative types)
            const typeConfig = {
                'R': { name: 'Projetos de Resolução', color: 'linear-gradient(135deg, #16a34a, #15803d)' },
                'J': { name: 'Projetos de Lei', color: 'linear-gradient(135deg, #2563eb, #1d4ed8)' },
                'P': { name: 'Propostas de Lei', color: 'linear-gradient(135deg, #9333ea, #7c3aed)' },
                'D': { name: 'Proj. Deliberação', color: 'linear-gradient(135deg, #ea580c, #dc2626)' },
                'I': { name: 'Inquéritos Parl.', color: 'linear-gradient(135deg, #0891b2, #0e7490)' },
                'S': { name: 'Propostas de Resolução', color: 'linear-gradient(135deg, #059669, #047857)' },
                'A': { name: 'Apreciações Parl.', color: 'linear-gradient(135deg, #d97706, #b45309)' }
            };

            let html = '';
            Object.entries(typeCounts)
                .sort((a, b) => b[1] - a[1])
                .forEach(([type, count]) => {
                    const config = typeConfig[type] || { name: type, color: 'linear-gradient(135deg, #6b7280, #4b5563)' };
                    html += `
                        <div class="type-card" style="background: ${config.color}">
                            <div class="type-card-value">${count}</div>
                            <div class="type-card-label">${config.name}</div>
                        </div>
                    `;
                });

            container.innerHTML = html;
        }

        function renderMonthWidget() {
            const container = document.getElementById('month-widget');

            // Count by month using first event date (Entrada)
            const monthCounts = {};
            INITIATIVES_DATA.forEach(ini => {
                const events = ini.IniEventos || [];
                if (events.length > 0) {
                    // Sort events by date and get the first one (Entrada)
                    const sortedEvents = events.slice().sort((a, b) =>
                        (a.DataFase || '').localeCompare(b.DataFase || '')
                    );
                    const firstDate = sortedEvents[0].DataFase;
                    if (firstDate) {
                        const monthKey = firstDate.substring(0, 7); // YYYY-MM
                        monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
                    }
                }
            });

            // Sort months chronologically
            const sortedMonths = Object.keys(monthCounts).sort();
            const maxCount = Math.max(...Object.values(monthCounts));

            // Month names in Portuguese
            const monthNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];

            let html = '';
            sortedMonths.forEach(monthKey => {
                const count = monthCounts[monthKey];
                const heightPercent = (count / maxCount) * 100;
                const [year, month] = monthKey.split('-');
                const monthName = monthNames[parseInt(month) - 1];
                const label = `${monthName}`;

                html += `
                    <div class="timeline-bar" style="height: ${heightPercent}%" title="${count} iniciativas em ${monthName} ${year}">
                        <span class="timeline-bar-value">${count}</span>
                        <span class="timeline-bar-label">${label}</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function renderAuthorWidget() {
            const container = document.getElementById('author-widget');

            // Count government initiatives
            let governmentCount = 0;
            INITIATIVES_DATA.forEach(ini => {
                if (ini.IniAutorOutros && ini.IniAutorOutros.nome === 'Governo') {
                    governmentCount++;
                }
            });

            // Count by parliamentary group
            const partyCounts = {};
            INITIATIVES_DATA.forEach(ini => {
                if (ini.IniAutorGruposParlamentares) {
                    const groups = Array.isArray(ini.IniAutorGruposParlamentares)
                        ? ini.IniAutorGruposParlamentares
                        : [ini.IniAutorGruposParlamentares];
                    groups.forEach(g => {
                        if (g.GP) {
                            partyCounts[g.GP] = (partyCounts[g.GP] || 0) + 1;
                        }
                    });
                }
            });

            // Sort parties by count descending
            const sortedParties = Object.entries(partyCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 8);

            // Build combined list: Government first, then parties
            const authors = [];
            if (governmentCount > 0) {
                authors.push(['Governo', governmentCount, 'government']);
            }
            sortedParties.forEach(([party, count]) => {
                authors.push([party, count, 'party']);
            });

            const maxCount = authors.length > 0 ? Math.max(...authors.map(a => a[1])) : 1;

            // Party color classes
            const partyColors = {
                'PAN': 'party-PAN',
                'CH': 'party-CH',
                'PCP': 'party-PCP',
                'L': 'party-L',
                'PS': 'party-PS',
                'BE': 'party-BE',
                'IL': 'party-IL',
                'CDS-PP': 'party-CDS-PP',
                'PSD': 'party-PSD'
            };

            let html = '';
            authors.forEach(([name, count, type]) => {
                const widthPercent = (count / maxCount) * 100;
                let barStyle = '';
                let colorClass = '';

                if (type === 'government') {
                    barStyle = 'background: linear-gradient(135deg, #6b7280, #4b5563)';
                } else {
                    colorClass = partyColors[name] || 'party-default';
                }

                html += `
                    <div class="bar-item">
                        <span class="bar-label">${name}</span>
                        <div class="bar-track">
                            <div class="bar-fill ${colorClass}" style="width: ${widthPercent}%${barStyle ? '; ' + barStyle : ''}">
                                <span class="bar-value">${count}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html || '<p style="color: var(--text-muted); text-align: center;">Sem dados</p>';
        }

        // Render Initiatives
        function getCurrentStatus(initiative) {
            return initiative._currentStatus || 'Desconhecido';
        }

        // Map type codes to short human-readable labels
        function getTypeLabel(typeCode) {
            const labels = {
                'J': 'Proj. Lei',
                'P': 'Prop. Lei',
                'R': 'Proj. Res.',
                'S': 'Prop. Res.',
                'D': 'Deliberação',
                'I': 'Inquérito',
                'A': 'Apreciação'
            };
            return labels[typeCode] || typeCode;
        }

        // Map 60+ phases to 7 simplified categories
        function getStatusCategory(status) {
            if (!status || status === 'Desconhecido') {
                return { category: 'submitted', label: 'Submetida', cssClass: 'status-submitted' };
            }

            const s = status.toLowerCase();

            // Approved (final positive states)
            if (s.includes('lei (publicação dr)') ||
                s.includes('resolução da ar (publicação dr)') ||
                s.includes('deliberação (publicação dr)')) {
                return { category: 'approved', label: 'Aprovada', cssClass: 'status-approved' };
            }

            // Rejected (final negative states)
            if (s.includes('rejeitad') ||
                s.includes('retirada') ||
                s.includes('caducad')) {
                return { category: 'rejected', label: 'Rejeitada', cssClass: 'status-rejected' };
            }

            // Finalizing (post-vote, pre-publication)
            if (s.includes('promulgação') ||
                s.includes('referenda') ||
                s.includes('redação final') ||
                s.includes('redacção final') ||
                s.includes('envio incm') ||
                s.includes('decreto (publicação)') ||
                s.includes('resolução (publicação dar)') ||
                s.includes('envio à comissão para fixação')) {
                return { category: 'finalizing', label: 'A finalizar', cssClass: 'status-finalizing' };
            }

            // Voting (critical decision points)
            if (s.includes('votação') ||
                s.includes('votacao')) {
                return { category: 'voting', label: 'Em votação', cssClass: 'status-voting' };
            }

            // In Discussion (active debate)
            if (s.includes('discussão') ||
                s.includes('discussao') ||
                s.includes('apreciação') ||
                s.includes('apreciacao') ||
                s.includes('parecer')) {
                return { category: 'discussion', label: 'Em discussão', cssClass: 'status-discussion' };
            }

            // Announced (committee assignment, waiting for discussion)
            if (s.includes('anúncio') ||
                s.includes('anuncio') ||
                s.includes('baixa comissão') ||
                s.includes('baixa comissao') ||
                s.includes('separata')) {
                return { category: 'announced', label: 'Anunciada', cssClass: 'status-announced' };
            }

            // Submitted (initial stages)
            if (s.includes('entrada') ||
                s.includes('publicação') ||
                s.includes('publicacao') ||
                s.includes('admissão') ||
                s.includes('admissao')) {
                return { category: 'submitted', label: 'Submetida', cssClass: 'status-submitted' };
            }

            // Default to announced for unknown active phases
            return { category: 'announced', label: 'Em progresso', cssClass: 'status-announced' };
        }

        function getAuthors(initiative) {
            const authors = [];

            if (initiative.IniAutorGruposParlamentares) {
                const groups = Array.isArray(initiative.IniAutorGruposParlamentares)
                    ? initiative.IniAutorGruposParlamentares
                    : [initiative.IniAutorGruposParlamentares];
                groups.forEach(g => {
                    if (g.GP) authors.push(g.GP);
                });
            }

            if (initiative.IniAutorOutros && initiative.IniAutorOutros.nome) {
                authors.push(initiative.IniAutorOutros.nome);
            }

            return authors.length > 0 ? authors.join(', ') : 'N/A';
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const [year, month, day] = dateStr.split('-');
            return `${day}/${month}/${year}`;
        }

        function renderInitiatives(filterType) {
            // If there's an active search, use the search results renderer instead
            if (SEARCH_RESULTS !== null) {
                const matchingIds = new Set(SEARCH_RESULTS.map(r => r.ini_id));
                const matchedInitiatives = INITIATIVES_DATA.filter(ini => matchingIds.has(ini.IniId));
                renderSearchResults(matchedInitiatives);
                return;
            }

            const container = document.getElementById('initiatives');
            let filtered = filterType === 'all'
                ? INITIATIVES_DATA
                : INITIATIVES_DATA.filter(ini => ini.IniTipo === filterType);

            let html = '';
            filtered.forEach(ini => {
                const status = getCurrentStatus(ini);
                const statusInfo = getStatusCategory(status);
                const authors = getAuthors(ini);
                const typeClass = `type-${ini.IniTipo}`;
                const events = ini.IniEventos || [];
                const sortedEvents = events.slice().sort((a, b) =>
                    (a.DataFase || '').localeCompare(b.DataFase || '')
                );

                const timeline = sortedEvents.map(evt => `
                    <div class="timeline-item">
                        <span class="timeline-date">${formatDate(evt.DataFase)}</span>
                        <span class="timeline-phase">${evt.Fase || 'N/A'}</span>
                    </div>
                `).join('');

                html += `
                    <article class="initiative-card" onclick="toggleCard(this, event)" onkeydown="handleInitiativeKeydown(event, this)" tabindex="0" role="button" aria-expanded="false" aria-label="${ini.IniTitulo}">
                        <div class="initiative-header">
                            <span class="initiative-badge ${typeClass}" aria-label="Tipo ${ini.IniDescTipo}">${getTypeLabel(ini.IniTipo)}</span>
                            <span class="initiative-number">${ini.IniNr}/${ini.IniTipo}</span>
                        </div>
                        <div class="initiative-title">${ini.IniTitulo}</div>
                        <div class="initiative-meta">
                            <span aria-label="Data de início"><span aria-hidden="true">📅</span> ${formatDate(ini.DataInicioleg)}</span>
                            <span aria-label="${events.length} fases"><span aria-hidden="true">📊</span> ${events.length} fases</span>
                        </div>
                        <div class="initiative-status ${statusInfo.cssClass}" title="${status}">
                            <span class="status-category-label">${statusInfo.label}</span>
                        </div>
                        <div class="initiative-details" aria-hidden="true">
                            <strong>Tipo:</strong> ${ini.IniDescTipo}<br>
                            <strong>Autores:</strong> ${authors}<br>
                            <strong>Legislatura:</strong> ${ini.IniLeg}<br>
                            ${ini.IniLinkTexto ? `<strong>Texto:</strong> <a href="${ini.IniLinkTexto}" target="_blank" rel="noopener">PDF</a><br>` : ''}
                            <div class="timeline">
                                <strong>Ciclo de vida (${events.length} eventos):</strong>
                                ${timeline}
                            </div>
                        </div>
                        <div class="expand-indicator">
                            <span class="expand-icon" aria-hidden="true">▼</span>
                            <span class="expand-text">Clique para ver ciclo de vida</span>
                        </div>
                    </article>
                `;
            });

            container.innerHTML = html || '<p style="text-align: center; color: #6b7280;">Nenhuma iniciativa encontrada</p>';
            container.classList.remove('loading');
        }

        function toggleCard(card, event) {
            // Prevent toggle if clicking on a link inside the card
            if (event && event.target.tagName === 'A') {
                return;
            }
            card.classList.toggle('expanded');
            const isExpanded = card.classList.contains('expanded');
            card.setAttribute('aria-expanded', isExpanded);

            const indicatorText = card.querySelector('.expand-text');
            if (indicatorText) {
                indicatorText.textContent = isExpanded ? 'Clique para ocultar' : 'Clique para ver ciclo de vida';
            }
        }

        function handleInitiativeKeydown(event, card) {
            if (event.key === 'Enter' || event.key === ' ') {
                event.preventDefault();
                toggleCard(card, event);
            }
        }

        function setupFilters() {
            // Type filter buttons
            const typeButtons = document.querySelectorAll('.filter-btn[data-type]');
            typeButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    typeButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const type = btn.dataset.type;
                    renderInitiatives(type);
                });
            });

            // Legislature filter buttons
            const legislatureButtons = document.querySelectorAll('.filter-btn[data-legislature]');
            legislatureButtons.forEach(btn => {
                btn.addEventListener('click', async () => {
                    legislatureButtons.forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const legislature = btn.dataset.legislature;
                    SELECTED_LEGISLATURE = legislature;

                    // Clear search when changing legislature
                    SEARCH_RESULTS = null;
                    const searchInput = document.getElementById('search-input');
                    if (searchInput) searchInput.value = '';
                    document.getElementById('clear-search-btn').classList.remove('visible');
                    document.getElementById('search-results-info').classList.remove('visible');

                    // Reload data with new legislature filter
                    document.getElementById('initiatives').innerHTML = '<div class="loading">A carregar iniciativas...</div>';
                    INITIATIVES_DATA = [];
                    await loadInitiatives();
                });
            });

            // Setup search on Enter key
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        performSearch();
                    }
                });
            }
        }

        // Search Functions
        async function performSearch() {
            const searchInput = document.getElementById('search-input');
            const searchBtn = document.getElementById('search-btn');
            const clearBtn = document.getElementById('clear-search-btn');
            const resultsInfo = document.getElementById('search-results-info');
            const query = searchInput.value.trim();

            if (!query) {
                clearSearch();
                return;
            }

            // Disable button while searching
            searchBtn.disabled = true;
            searchBtn.textContent = 'A pesquisar...';

            try {
                // Convert query to tsquery format (add :* for prefix matching)
                const tsQuery = query.split(/\s+/).map(word => word + ':*').join(' & ');

                // Build URL with legislature filter if selected
                let url = `${API_URL}/api/search?q=${encodeURIComponent(tsQuery)}&limit=100`;
                if (SELECTED_LEGISLATURE !== 'all') {
                    url += `&legislature=${SELECTED_LEGISLATURE}`;
                }

                const response = await fetch(url);

                if (!response.ok) {
                    throw new Error(`Search failed: ${response.status}`);
                }

                const results = await response.json();
                SEARCH_RESULTS = results;

                // Show results info
                resultsInfo.textContent = `Encontradas ${results.length} iniciativa${results.length !== 1 ? 's' : ''} para "${query}"`;
                resultsInfo.classList.add('visible');
                clearBtn.classList.add('visible');

                // Get the matching initiative IDs
                const matchingIds = new Set(results.map(r => r.ini_id));

                // Filter INITIATIVES_DATA to only show matching initiatives
                const matchedInitiatives = INITIATIVES_DATA.filter(ini => matchingIds.has(ini.IniId));

                // Render only matching initiatives
                renderSearchResults(matchedInitiatives);

            } catch (error) {
                console.error('Search error:', error);
                resultsInfo.textContent = `Erro na pesquisa: ${error.message}`;
                resultsInfo.classList.add('visible');
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Pesquisar';
            }
        }

        function clearSearch() {
            const searchInput = document.getElementById('search-input');
            const clearBtn = document.getElementById('clear-search-btn');
            const resultsInfo = document.getElementById('search-results-info');

            searchInput.value = '';
            SEARCH_RESULTS = null;
            clearBtn.classList.remove('visible');
            resultsInfo.classList.remove('visible');

            // Re-render with current filter
            const activeFilter = document.querySelector('.filter-btn.active');
            const type = activeFilter ? activeFilter.dataset.type : 'all';
            renderInitiatives(type);
        }

        function renderSearchResults(matchedInitiatives) {
            const container = document.getElementById('initiatives');

            // Apply current type filter to search results
            const activeFilter = document.querySelector('.filter-btn.active');
            const filterType = activeFilter ? activeFilter.dataset.type : 'all';

            let filtered = filterType === 'all'
                ? matchedInitiatives
                : matchedInitiatives.filter(ini => ini.IniTipo === filterType);

            let html = '';
            filtered.forEach(ini => {
                const status = getCurrentStatus(ini);
                const statusInfo = getStatusCategory(status);
                const authors = getAuthors(ini);
                const typeClass = `type-${ini.IniTipo}`;
                const events = ini.IniEventos || [];
                const sortedEvents = events.slice().sort((a, b) =>
                    (a.DataFase || '').localeCompare(b.DataFase || '')
                );

                const timeline = sortedEvents.map(evt => `
                    <div class="timeline-item">
                        <span class="timeline-date">${formatDate(evt.DataFase)}</span>
                        <span class="timeline-phase">${evt.Fase || 'N/A'}</span>
                    </div>
                `).join('');

                html += `
                    <article class="initiative-card" onclick="toggleCard(this, event)" onkeydown="handleInitiativeKeydown(event, this)" tabindex="0" role="button" aria-expanded="false" aria-label="${ini.IniTitulo}">
                        <div class="initiative-header">
                            <span class="initiative-badge ${typeClass}" aria-label="Tipo ${ini.IniDescTipo}">${getTypeLabel(ini.IniTipo)}</span>
                            <span class="initiative-number">${ini.IniNr}/${ini.IniTipo}</span>
                        </div>
                        <div class="initiative-title">${ini.IniTitulo}</div>
                        <div class="initiative-meta">
                            <span aria-label="Data de início"><span aria-hidden="true">📅</span> ${formatDate(ini.DataInicioleg)}</span>
                            <span aria-label="${events.length} fases"><span aria-hidden="true">📊</span> ${events.length} fases</span>
                        </div>
                        <div class="initiative-status ${statusInfo.cssClass}" title="${status}">
                            <span class="status-category-label">${statusInfo.label}</span>
                        </div>
                        <div class="initiative-details" aria-hidden="true">
                            <strong>Tipo:</strong> ${ini.IniDescTipo}<br>
                            <strong>Autores:</strong> ${authors}<br>
                            <strong>Legislatura:</strong> ${ini.IniLeg}<br>
                            ${ini.IniLinkTexto ? `<strong>Texto:</strong> <a href="${ini.IniLinkTexto}" target="_blank" rel="noopener">PDF</a><br>` : ''}
                            <div class="timeline">
                                <strong>Ciclo de vida (${events.length} eventos):</strong>
                                ${timeline}
                            </div>
                        </div>
                        <div class="expand-indicator">
                            <span class="expand-icon" aria-hidden="true">▼</span>
                            <span class="expand-text">Clique para ver ciclo de vida</span>
                        </div>
                    </article>
                `;
            });

            container.innerHTML = html || '<p style="text-align: center; color: #6b7280;">Nenhuma iniciativa encontrada</p>';
            container.classList.remove('loading');
        }

        // Render Agenda - Grid Calendar Layout
        function renderAgenda() {
            const container = document.getElementById('agenda');

            // Filter out metadata events and apply type filters
            const realEvents = AGENDA_DATA.filter(e => {
                if (e.Title.includes('Calendarização')) return false;
                const type = getAgendaEventType(e.Section, e.Title);
                return AGENDA_FILTERS[type];
            });

            // Group by date
            const grouped = {};
            realEvents.forEach(event => {
                const date = event.EventStartDate;
                if (!grouped[date]) grouped[date] = [];
                grouped[date].push(event);
            });

            // Get unique dates sorted
            const dates = Object.keys(grouped).sort((a, b) => parseAgendaDate(a) - parseAgendaDate(b));

            // Take first 7 days max
            const displayDates = dates.slice(0, 7);

            // Find time range (min/max hours)
            let minHour = 24, maxHour = 0;
            displayDates.forEach(date => {
                grouped[date].forEach(event => {
                    const hour = getAgendaHour(event.EventStartTime);
                    if (hour !== null) {
                        minHour = Math.min(minHour, hour);
                        maxHour = Math.max(maxHour, hour);
                    }
                });
            });

            // Default range if no times
            if (minHour > maxHour) {
                minHour = 9;
                maxHour = 18;
            }

            // Build grid
            let html = '<div class="calendar-grid">';

            // Header row - empty corner + day headers
            html += '<div class="time-label" style="border-bottom: 1px solid var(--border-light);"></div>';

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            displayDates.forEach(date => {
                const dateObj = parseAgendaDate(date);
                const dayName = dateObj.toLocaleDateString('pt-PT', { weekday: 'short' }).replace('.', '');
                const dayNum = dateObj.getDate();
                const isToday = dateObj.getTime() === today.getTime();

                html += `
                    <div class="calendar-day-header ${isToday ? 'today' : ''}">
                        <div class="calendar-day-name">${dayName}</div>
                        <div class="calendar-day-date">${dayNum}</div>
                    </div>
                `;
            });

            // Time rows
            for (let hour = minHour; hour <= maxHour; hour++) {
                // Time label
                html += `<div class="time-label">${hour.toString().padStart(2, '0')}:00</div>`;

                // Cells for each day
                displayDates.forEach(date => {
                    const dateObj = parseAgendaDate(date);
                    const isToday = dateObj.getTime() === today.getTime();

                    // Get events for this hour on this day
                    const hourEvents = (grouped[date] || []).filter(e => {
                        const eventHour = getAgendaHour(e.EventStartTime);
                        return eventHour === hour;
                    });

                    // Also include all-day events (no time) in first row
                    if (hour === minHour) {
                        const allDayEvents = (grouped[date] || []).filter(e => !e.EventStartTime);
                        hourEvents.push(...allDayEvents);
                    }

                    html += `<div class="grid-cell ${isToday ? 'today' : ''}">`;

                    hourEvents.forEach(event => {
                        const type = getAgendaEventType(event.Section, event.Title);
                        const title = shortenAgendaTitle(event.Title);
                        html += `<div class="agenda-event ${type}" title="${event.Title}" onclick="showAgendaInitiatives(${event.Id})">${title}</div>`;
                    });

                    html += '</div>';
                });
            }

            html += '</div>';
            container.innerHTML = html;
            container.classList.remove('loading');
        }

        function parseAgendaDate(dateStr) {
            const [day, month, year] = dateStr.split('/');
            return new Date(year, month - 1, day);
        }

        function getAgendaHour(timeStr) {
            if (!timeStr) return null;
            const hour = parseInt(timeStr.split(':')[0]);
            return hour;
        }

        function getAgendaEventType(section, title) {
            // Check section for specific event types
            if (section.includes('Visitas')) return 'visits';
            if (section.includes('Assistências')) return 'assistances';
            if (section.includes('Conferência')) return 'conference';
            if (section.includes('Grupo de Trabalho')) return 'workgroup';
            // Check title for specific patterns
            if (title && (title.includes('Audiências') || title.includes('Audiência'))) return 'groups';
            // Core parliamentary types
            if (section.includes('Plenário') || section.includes('Plenario')) return 'plenary';
            if (section.includes('Grupos') || section.includes('Partidos') || section.includes('DURP')) return 'groups';
            if (section.includes('Comiss')) return 'committee';
            return 'other';
        }

        function shortenAgendaTitle(title) {
            title = title.replace('Comissão Parlamentar de Inquérito', 'CPI');
            title = title.replace('Comissão de ', '');
            title = title.replace('Audiências do Grupo Parlamentar', 'Audiências GP');
            title = title.replace('Audiências do Grupo parlamentar', 'Audiências GP');
            title = title.replace('Grupo de Trabalho', 'GT');
            title = title.replace('Conferência de Líderes', 'Conf. Líderes');
            return title;
        }

        // Agenda View State
        let CURRENT_AGENDA_VIEW = 'timeline';
        const TIMELINE_START_HOUR = 8;
        const TIMELINE_END_HOUR = 22;
        const TIMELINE_TOTAL_HOURS = TIMELINE_END_HOUR - TIMELINE_START_HOUR + 1;

        // Agenda filter state - which event types to show
        const AGENDA_FILTERS = {
            plenary: true,
            committee: true,
            groups: true,
            visits: true,
            conference: true,
            workgroup: true,
            assistances: true
        };

        function toggleAgendaFilter(type, checked) {
            AGENDA_FILTERS[type] = checked;

            // Update visual state
            const label = document.querySelector(`.legend-filter[data-type="${type}"]`);
            if (label) {
                label.classList.toggle('active', checked);
            }

            // Re-render
            if (CURRENT_AGENDA_VIEW === 'timeline') {
                renderAgendaTimeline();
            } else {
                renderAgenda();
            }
        }

        function setAgendaView(view) {
            CURRENT_AGENDA_VIEW = view;

            // Update button states
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            // Re-render agenda
            if (view === 'grid') {
                renderAgenda();
            } else {
                renderAgendaTimeline();
            }
        }

        function timeToPercent(hour, minute = 0) {
            const totalMinutes = (hour - TIMELINE_START_HOUR) * 60 + minute;
            const totalTimelineMinutes = TIMELINE_TOTAL_HOURS * 60;
            return (totalMinutes / totalTimelineMinutes) * 100;
        }

        function getMinute(timeStr) {
            if (!timeStr) return 0;
            return parseInt(timeStr.split(':')[1] || 0);
        }

        // Render Agenda Timeline View
        function renderAgendaTimeline() {
            const container = document.getElementById('agenda');
            const EVENT_HEIGHT = 18; // Height per event row in pixels

            // Filter out metadata events and apply type filters
            const realEvents = AGENDA_DATA.filter(e => {
                if (e.Title.includes('Calendarização')) return false;
                const type = getAgendaEventType(e.Section, e.Title);
                return AGENDA_FILTERS[type];
            });

            // Group by date
            const grouped = {};
            realEvents.forEach(event => {
                const date = event.EventStartDate;
                if (!grouped[date]) grouped[date] = [];
                grouped[date].push(event);
            });

            // Get date range: from first to last event date (including weekends in between)
            const eventDates = Object.keys(grouped).sort((a, b) => parseAgendaDate(a) - parseAgendaDate(b));

            if (eventDates.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 40px;">Sem eventos agendados</p>';
                container.classList.remove('loading');
                return;
            }

            const startDate = parseAgendaDate(eventDates[0]);
            const endDate = parseAgendaDate(eventDates[eventDates.length - 1]);

            // Generate all days from first to last event (including weekends)
            const displayDates = [];
            const currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const dateStr = `${currentDate.getDate().toString().padStart(2, '0')}/${(currentDate.getMonth() + 1).toString().padStart(2, '0')}/${currentDate.getFullYear()}`;
                displayDates.push(dateStr);
                currentDate.setDate(currentDate.getDate() + 1);
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let html = '<div class="timeline-container"><div class="timeline">';

            // Hour headers row
            html += '<div class="hour-headers">';
            html += '<div class="hour-header"></div>';
            for (let h = TIMELINE_START_HOUR; h <= TIMELINE_END_HOUR; h++) {
                html += `<div class="hour-header">${h.toString().padStart(2, '0')}h</div>`;
            }
            html += '</div>';

            // Day rows
            displayDates.forEach(date => {
                const dateObj = parseAgendaDate(date);
                const dayName = dateObj.toLocaleDateString('pt-PT', { weekday: 'short' }).replace('.', '');
                const dayNum = dateObj.getDate();
                const monthNum = dateObj.getMonth() + 1;
                const isToday = dateObj.getTime() === today.getTime();
                const isWeekend = dateObj.getDay() === 0 || dateObj.getDay() === 6;

                const dayEvents = grouped[date] || [];
                dayEvents.sort((a, b) => {
                    const aHour = getAgendaHour(a.EventStartTime) || 0;
                    const bHour = getAgendaHour(b.EventStartTime) || 0;
                    return aHour - bHour;
                });

                // First pass: calculate positions and max stack depth
                let eventStacks = [];
                const eventPositions = [];

                dayEvents.forEach(event => {
                    let startHour = getAgendaHour(event.EventStartTime);
                    let startMin = getMinute(event.EventStartTime);
                    let endHour = getAgendaHour(event.EventEndTime);
                    let endMin = getMinute(event.EventEndTime);

                    const isAllDay = startHour === null;
                    if (isAllDay) {
                        startHour = TIMELINE_START_HOUR;
                        startMin = 0;
                        endHour = TIMELINE_END_HOUR;
                        endMin = 59;
                    }

                    if (endHour === null || endHour === 23) {
                        endHour = TIMELINE_END_HOUR;
                        endMin = 59;
                    }

                    if (endHour <= startHour && !isAllDay) {
                        endHour = Math.min(startHour + 1, TIMELINE_END_HOUR);
                        endMin = 0;
                    }

                    const leftPercent = timeToPercent(startHour, startMin);
                    const rightPercent = timeToPercent(endHour, endMin);
                    const widthPercent = Math.max(rightPercent - leftPercent, 4);

                    // Find stack position
                    let stackPos = 0;
                    for (let s = 0; s < eventStacks.length; s++) {
                        const canFit = eventStacks[s].every(e =>
                            leftPercent >= e.right || (leftPercent + widthPercent) <= e.left
                        );
                        if (canFit) {
                            stackPos = s;
                            break;
                        }
                        stackPos = s + 1;
                    }

                    if (!eventStacks[stackPos]) eventStacks[stackPos] = [];
                    eventStacks[stackPos].push({ left: leftPercent, right: leftPercent + widthPercent });

                    eventPositions.push({
                        event,
                        leftPercent,
                        widthPercent,
                        stackPos
                    });
                });

                const maxStacks = eventStacks.length || 1;
                const rowHeight = maxStacks * EVENT_HEIGHT;

                const rowClasses = ['day-row'];
                if (isToday) rowClasses.push('today');
                if (isWeekend) rowClasses.push('weekend');
                html += `<div class="${rowClasses.join(' ')}" style="min-height: ${rowHeight}px;">`;
                html += `
                    <div class="day-label">
                        <div class="day-name">${dayName}</div>
                        <div class="day-date">${dayNum}/${monthNum}</div>
                    </div>
                `;

                html += `<div class="events-area" style="height: ${rowHeight}px;">`;

                // Hour grid lines
                html += '<div class="hour-grid">';
                for (let h = TIMELINE_START_HOUR; h <= TIMELINE_END_HOUR; h++) {
                    html += '<div class="hour-line"></div>';
                }
                html += '</div>';

                // Render events with calculated positions
                eventPositions.forEach(({ event, leftPercent, widthPercent, stackPos }) => {
                    const type = getAgendaEventType(event.Section, event.Title);
                    const title = shortenAgendaTitle(event.Title);
                    const topPx = stackPos * EVENT_HEIGHT + 1;
                    const timeDisplay = event.EventStartTime ? event.EventStartTime.substring(0, 5) : '';

                    html += `
                        <div class="timeline-event ${type}"
                             title="${event.Title}"
                             onclick="showAgendaInitiatives(${event.Id})"
                             style="left: ${leftPercent}%; width: ${widthPercent}%; top: ${topPx}px;">
                            <span class="event-time">${timeDisplay}</span>
                            <span class="event-title">${title}</span>
                        </div>
                    `;
                });

                html += '</div>'; // events-area
                html += '</div>'; // day-row
            });

            html += '</div></div>';
            container.innerHTML = html;
            container.classList.remove('loading');
        }

        // Agenda Event Modal Functions
        async function showAgendaInitiatives(eventId) {
            const modal = document.getElementById('agenda-initiatives-modal');
            const modalBody = document.getElementById('modal-initiatives-body');
            const modalTitle = document.getElementById('modal-event-title');
            const modalSubtitle = document.getElementById('modal-event-subtitle');

            // Show modal with loading state
            modal.classList.add('active');
            modalBody.innerHTML = `
                <div class="modal-loading">
                    <div class="modal-loading-spinner"></div>
                    <div>A carregar iniciativas...</div>
                </div>
            `;

            try {
                const response = await fetch(`${API_URL}/api/agenda/${eventId}/initiatives`);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const { agenda_event, linked_initiatives } = data;

                // Update modal header
                modalTitle.textContent = agenda_event.title;
                modalSubtitle.textContent = `${agenda_event.date} • ${agenda_event.committee || agenda_event.section}`;

                // Helper to decode HTML entities
                function decodeHtml(html) {
                    const txt = document.createElement('textarea');
                    txt.innerHTML = html;
                    return txt.value;
                }

                // Build modal content
                let html = '';

                // Show event description if available
                if (agenda_event.description_html) {
                    const decodedHtml = decodeHtml(agenda_event.description_html);
                    html += `<div class="event-description">${decodedHtml}</div>`;
                }

                // Render initiatives
                if (linked_initiatives.length === 0) {
                    if (!agenda_event.description_html) {
                        html += `
                            <div class="modal-empty">
                                <div class="modal-empty-icon">📋</div>
                                <div>Sem informação adicional para este evento.</div>
                            </div>
                        `;
                    }
                } else {
                    html += `<div class="initiatives-section-title">Iniciativas Legislativas</div>`;
                    linked_initiatives.forEach(ini => {
                        const statusInfo = getStatusCategory(ini.status || 'Em curso');
                        html += `
                            <div class="linked-initiative">
                                <div class="initiative-header-row">
                                    <span class="initiative-type-badge">${ini.type_description}</span>
                                    <span class="initiative-id">ID: ${ini.ini_id}</span>
                                </div>
                                <div class="initiative-title-text">${ini.title}</div>
                                <div class="initiative-meta-row">
                                    ${ini.author ? `
                                        <div class="initiative-meta-item">
                                            <span class="initiative-meta-label">Autor:</span> ${ini.author}
                                        </div>
                                    ` : ''}
                                    <div class="initiative-meta-item">
                                        <span class="initiative-meta-label">Estado:</span>
                                        <span class="initiative-status ${statusInfo.cssClass}" title="${ini.status || ''}">${statusInfo.label}</span>
                                    </div>
                                </div>
                                ${ini.text_link ? `
                                    <a href="${ini.text_link}" target="_blank" class="initiative-link-btn" rel="noopener">
                                        Ver detalhes completos →
                                    </a>
                                ` : ''}
                            </div>
                        `;
                    });
                }
                modalBody.innerHTML = html;
            } catch (error) {
                console.error('Error loading agenda initiatives:', error);
                modalBody.innerHTML = `
                    <div class="modal-error">
                        <div class="modal-error-icon">⚠️</div>
                        <div>Erro ao carregar iniciativas</div>
                        <div style="font-size: 0.85rem; margin-top: 8px;">
                            ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        function closeAgendaModal() {
            const modal = document.getElementById('agenda-initiatives-modal');
            modal.classList.remove('active');
        }

        // Close modal on overlay click
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                closeAgendaModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAgendaModal();
            }
        });

        // Initialize
        window.addEventListener('hashchange', handleRoute);
        window.addEventListener('DOMContentLoaded', handleRoute);
    </script>

    <!-- Agenda Initiatives Modal -->
    <div id="agenda-initiatives-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-header-content">
                    <div class="modal-title" id="modal-event-title">Evento</div>
                    <div class="modal-subtitle" id="modal-event-subtitle"></div>
                </div>
                <button class="modal-close" onclick="closeAgendaModal()" aria-label="Fechar">×</button>
            </div>
            <div class="modal-body" id="modal-initiatives-body">
                <!-- Content loaded dynamically -->
            </div>
        </div>
    </div>

</body>
</html>
